if (!text) {
    feedback.innerHTML = '';
    return;
}

// Capital letter check
if (text[0] === text[0].toLowerCase()) {
    messages.push('<p class="error">Your sentence should start with a capital letter.</p>');
}

// Proper ending punctuation
if (!/[.!?]$/.test(text)) {
    messages.push('<p class="error">Your sentence should end with proper punctuation (. ! or ?).</p>');
}

// Question check - topic sentences should be statements, not questions
if (text.trim().endsWith('?')) {
    messages.push('<p class="error">Topic sentences should be statements, not questions. Make a claim instead of asking.</p>');
}

// Sentence length check - more strict
const words = text.split(/\s+/);
if (text.length < 15) {
    messages.push('<p class="error">Too short. A strong topic sentence needs more development (aim for at least 10-15 words).</p>');
} else if (words.length < 8) {
    messages.push('<p class="warn">Your sentence is quite brief. Consider adding more detail about your main point.</p>');
} else if (words.length >= 8 && words.length <= 25) {
    messages.push('<p>‚úîÔ∏è Good sentence length.</p>');
} else {
    messages.push('<p class="warn">Your sentence is quite long. Consider breaking it into two sentences or simplifying.</p>');
}

// Check for weak starters
const weakStarters = /^(i think|i believe|i feel|in my opinion|i guess|i would say|this essay|this paragraph|this paper)/i;
if (weakStarters.test(text)) {
    messages.push('<p class="error">Avoid weak starters like "I think," "I believe," or "This essay." State your claim directly and confidently.</p>');
}

// Check for answer-like phrasing
if (/^(yes|no|maybe|sure|not really|kind of|sort of)/i.test(text)) {
    messages.push('<p class="error">This sounds like a simple answer, not a topic sentence. Restate the question as a complete claim in your own words.</p>');
}

// Check for subject and specificity
const pronouns = ["he", "she", "they", "it", "we", "you", "i"];
const contentWords = text.toLowerCase().replace(/[^a-z\s]/g, '').split(/\s+/);
const mainWords = contentWords.filter(w => w.length > 3 && !pronouns.includes(w));

if (mainWords.length === 0) {
    messages.push('<p class="error">Your sentence needs a clear, specific subject. What exactly are you writing about?</p>');
} else if (mainWords.length < 3) {
    messages.push('<p class="warn">Your topic sentence could be more specific. Add more detail about your subject.</p>');
} else {
    messages.push('<p>‚úîÔ∏è Your sentence has a clear subject.</p>');
}

// Check for vague language
const vagueWords = /(thing|stuff|good|bad|nice|interesting|a lot|very|really|some|many)/i;
if (vagueWords.test(text)) {
    messages.push('<p class="warn">Try to be more specific. Avoid vague words like "thing," "stuff," "good," "bad," "nice," "interesting," etc.</p>');
}

// Check for purpose and direction (FIXED REGEX)
const purposefulPatterns = /(should|must|because|since|therefore|demonstrates|proves|shows|reveals|argues|suggests|explains|indicates|illustrates|the main reason|one reason)/i;
if (purposefulPatterns.test(text)) {
    messages.push('<p>‚úîÔ∏è Your sentence has clear direction and purpose. Excellent!</p>');
} else {
    messages.push('<p class="warn">Your sentence needs stronger direction. Include words that show your position or reasoning (e.g., "because," "demonstrates," "proves," "should").</p>');
}

// Check for listing or announcement
if (/will (discuss|talk about|explain|write about|tell you)/i.test(text)) {
    messages.push('<p class="error">Don\'t announce what you\'ll do ("I will discuss..."). Instead, make your claim directly.</p>');
}

// Check for multiple sentences
const sentenceCount = (text.match(/[.!?]+/g) || []).length;
if (sentenceCount > 1) {
    messages.push('<p class="warn">A topic sentence should typically be ONE sentence. Consider combining your ideas or using only the strongest one.</p>');
}

// Check for contractions (more formal writing)
if (/n\'t|\'re|\'ve|\'ll|\'d|\'s/.test(text)) {
    messages.push('<p class="warn">Avoid contractions in formal writing. Write out "don\'t" as "do not," etc.</p>');
}

// Overall assessment
const errorCount = messages.filter(m => m.includes('class="error"')).length;
const warnCount = messages.filter(m => m.includes('class="warn"')).length;

if (errorCount === 0 && warnCount === 0) {
    messages.push('<p style="background: rgba(16, 185, 129, 0.2); font-weight: bold;">üåü Excellent topic sentence! This is ready to use.</p>');
} else if (errorCount === 0 && warnCount <= 2) {
    messages.push('<p style="background: rgba(34, 197, 94, 0.15);">‚úÖ Good topic sentence! Consider addressing the suggestions above to make it even stronger.</p>');
} else if (errorCount > 0) {
    messages.push('<p style="background: rgba(239, 68, 68, 0.2); font-weight: bold;">‚ö†Ô∏è This needs revision. Please address the errors above before continuing.</p>');
}

feedback.innerHTML = messages.join('');
