<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Written Response Builder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
      min-height: 100vh; padding: 20px; color: #e8edf5;
    }
    .container { max-width: 1400px; margin: 0 auto; background: rgba(30, 41, 59, 0.95);
      border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .header { background: linear-gradient(135deg, rgba(59,130,246,.3), rgba(147,51,234,.3)); backdrop-filter: blur(10px);
      color: #fff; padding: 30px 40px; border-bottom: 1px solid rgba(255,255,255,.1); }
    .header h1 { font-size: 2em; margin-bottom: 8px; font-weight: 600; }
    .header p { font-size: 1em; opacity: .8; }
    .content { padding: 30px 40px; display: grid; gap: 20px; }

    .prompt-section, .writing-section { background: rgba(51,65,85,.6); border: 1px solid rgba(255,255,255,.1); padding: 20px; border-radius: 12px; }
    .writing-section { transition: all .3s ease; }
    .writing-section:hover { border-color: rgba(59,130,246,.5); background: rgba(51,65,85,.7); }

    .prompt-section h2 { color: #e8edf5; margin-bottom: 12px; font-size: 1.2em; font-weight: 500; }
    .prompt-input, .content-textarea { width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,.2);
      border-radius: 8px; font-size: 1em; resize: vertical; font-family: inherit; background: rgba(30,41,59,.8); color: #e8edf5; }
    .prompt-input:focus, .content-textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.1); }

    .section-header { display: flex; align-items: center; margin-bottom: 15px; gap: 15px; }
    .section-title { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; padding: 8px 16px; border-radius: 6px;
      font-weight: 600; font-size: .9em; text-transform: uppercase; letter-spacing: .5px; }
    .topic-sentence .section-title { background: linear-gradient(135deg, #10b981, #059669); }
    .supporting-detail-1 .section-title { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .supporting-detail-2 .section-title { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
    .supporting-detail-3 .section-title { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .conclusion .section-title { background: linear-gradient(135deg, #ef4444, #dc2626); }

    .writing-content { display: flex; gap: 15px; align-items: flex-start; }
    .transition-dropdown { min-width: 180px; }
    .transition-dropdown select { width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,.2); border-radius: 8px; font-size: .95em; background: rgba(30,41,59,.8); color: #e8edf5; cursor: pointer; }
    .transition-dropdown select:focus { outline: none; border-color: #3b82f6; }

    .content-input { flex: 1; }
    .topic-sentence .content-textarea { min-height: 70px; }

    .tips { margin-top: 10px; padding: 10px; background: rgba(59,130,246,.1); border-radius: 6px; border-left: 3px solid #3b82f6; font-size: .85em; color: #cbd5e1; }
    .word-count { background: rgba(30,41,59,.8); padding: 8px 14px; border-radius: 6px; font-size: .85em; color: #94a3b8; border: 1px solid rgba(255,255,255,.1); margin-left: auto; }

    .feedback { margin-top: 10px; }
    .feedback p { margin: 6px 0; padding: 8px 12px; background: rgba(16,185,129,.1); border-left: 3px solid #10b981; border-radius: 6px; font-size: .85em; }
    .feedback p.warn { background: rgba(245,158,11,.1); border-left-color: #f59e0b; }
    .feedback p.error { background: rgba(239,68,68,.1); border-left-color: #ef4444; }

    .actions { display: flex; gap: 12px; justify-content: center; margin-top: 20px; padding: 20px; background: rgba(51,65,85,.4); border-radius: 12px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: .95em; font-weight: 600; cursor: pointer; transition: all .3s ease; border: 1px solid transparent; }
    .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
    .btn-secondary { background: rgba(100,116,139,.8); color: #fff; border: 1px solid rgba(255,255,255,.2); }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,.3); }

    .preview-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 1000; backdrop-filter: blur(5px); }
    .preview-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(30,41,59,.98);
      padding: 30px; border-radius: 15px; max-width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,.5); border: 1px solid rgba(255,255,255,.1); }
    .preview-content h2 { color: #e8edf5; margin-bottom: 20px; }
    .preview-text { line-height: 1.8; font-size: 1.05em; color: #cbd5e1; white-space: pre-wrap; }

    textarea::placeholder, select option:first-child { color: #64748b; }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: rgba(30,41,59,.5); }
    ::-webkit-scrollbar-thumb { background: rgba(59,130,246,.5); border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(59,130,246,.7); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìù Written Response Builder</h1>
      <p>Structure your essay with clear organization and smooth transitions</p>
    </div>

    <div class="content">
      <div class="prompt-section">
        <h2>üìã Writing Prompt/Question</h2>
        <textarea class="prompt-input" id="promptInput" placeholder="Paste your writing prompt or question here..."></textarea>
      </div>

      <div class="writing-section topic-sentence">
        <div class="section-header">
          <div class="section-title">Topic Sentence</div>
          <div class="word-count" id="topicWordCount">0 words</div>
        </div>
        <div class="writing-content">
          <div class="content-input">
            <textarea class="content-textarea" id="topicSentence" placeholder="Write your main thesis or topic sentence here. This should clearly state your position or main argument..."></textarea>
            <div class="feedback" id="topicFeedback" aria-live="polite"></div>
            <div class="tips">üí° <strong>Tip:</strong> Your topic sentence should clearly state your main argument and preview what you'll discuss in your supporting details.</div>
          </div>
        </div>
      </div>

      <div class="writing-section supporting-detail-1">
        <div class="section-header">
          <div class="section-title">Supporting Detail 1</div>
          <div class="word-count" id="detail1WordCount">0 words</div>
        </div>
        <div class="writing-content">
          <div class="transition-dropdown">
            <select id="transition1">
              <option value="">Choose transition...</option>
              <option value="First,">First,</option>
              <option value="To begin with,">To begin with,</option>
              <option value="Initially,">Initially,</option>
              <option value="One reason is that">One reason is that</option>
              <option value="The first point is">The first point is</option>
              <option value="For instance,">For instance,</option>
              <option value="For example,">For example,</option>
            </select>
          </div>
          <div class="content-input">
            <textarea class="content-textarea" id="supportingDetail1" placeholder="Provide your first supporting point with evidence and explanation..."></textarea>
            <div class="feedback" id="detail1Feedback" aria-live="polite"></div>
            <div class="tips">üí° <strong>Tip:</strong> Include specific evidence, examples, or reasoning to support your main argument.</div>
          </div>
        </div>
      </div>

      <div class="writing-section supporting-detail-2">
        <div class="section-header">
          <div class="section-title">Supporting Detail 2</div>
          <div class="word-count" id="detail2WordCount">0 words</div>
        </div>
        <div class="writing-content">
          <div class="transition-dropdown">
            <select id="transition2">
              <option value="">Choose transition...</option>
              <option value="Second,">Second,</option>
              <option value="Additionally,">Additionally,</option>
              <option value="Furthermore,">Furthermore,</option>
              <option value="Another reason is">Another reason is</option>
              <option value="In addition,">In addition,</option>
              <option value="Moreover,">Moreover,</option>
              <option value="Also,">Also,</option>
            </select>
          </div>
          <div class="content-input">
            <textarea class="content-textarea" id="supportingDetail2" placeholder="Provide your second supporting point with evidence and explanation...	extarea>
            <div class="feedback" id="detail2Feedback" aria-live="polite"></div>
            <div class="tips">üí° <strong>Tip:</strong> Make sure this point is different from your first detail but still supports your main argument.</div>
          </div>
        </div>
      </div>

      <div class="writing-section supporting-detail-3">
        <div class="section-header">
          <div class="section-title">Supporting Detail 3</div>
          <div class="word-count" id="detail3WordCount">0 words</div>
        </div>
        <div class="writing-content">
          <div class="transition-dropdown">
            <select id="transition3">
              <option value="">Choose transition...</option>
              <option value="Third,">Third,</option>
              <option value="Finally,">Finally,</option>
              <option value="Lastly,">Lastly,</option>
              <option value="Most importantly,">Most importantly,</option>
              <option value="The final reason is">The final reason is</option>
              <option value="In conclusion,">In conclusion,</option>
              <option value="Above all,">Above all,</option>
            </select>
          </div>
          <div class="content-input">
            <textarea class="content-textarea" id="supportingDetail3" placeholder="Provide your third supporting point with evidence and explanation..."></textarea>
            <div class="feedback" id="detail3Feedback" aria-live="polite"></div>
            <div class="tips">üí° <strong>Tip:</strong> Consider making this your strongest point to leave a lasting impression.</div>
          </div>
        </div>
      </div>

      <div class="writing-section conclusion">
        <div class="section-header">
          <div class="section-title">Conclusion</div>
          <div class="word-count" id="conclusionWordCount">0 words</div>
        </div>
        <div class="writing-content">
          <div class="transition-dropdown">
            <select id="transitionConclusion">
              <option value="">Choose transition...</option>
              <option value="In conclusion,">In conclusion,</option>
              <option value="To summarize,">To summarize,</option>
              <option value="In summary,">In summary,</option>
              <option value="Therefore,">Therefore,</option>
              <option value="As a result,">As a result,</option>
              <option value="That is why,">That is why,</option>
              <option value="Ultimately,">Ultimately,</option>
            </select>
          </div>
          <div class="content-input">
            <textarea class="content-textarea" id="conclusion" placeholder="Restate your main argument and summarize your key points. End with a strong closing thought..."></textarea>
            <div class="feedback" id="conclusionFeedback" aria-live="polite"></div>
            <div class="tips">üí° <strong>Tip:</strong> Restate your thesis in different words and leave the reader with something to think about.</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
        <button class="btn btn-primary" onclick="previewResponse()">üëÅÔ∏è Preview Response</button>
        <button class="btn btn-success" onclick="copyResponse()">üìã Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <div class="preview-modal" id="previewModal">
    <div class="preview-content">
      <h2>üìÑ Your Written Response</h2>
      <div class="preview-text" id="previewText"></div>
      <div style="text-align:center; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closePreview()">Close</button>
      </div>
    </div>
  </div>

  <!-- Inject Language Arts return button -->
  <script>
    (function () {
      try {
        var btn = document.createElement('a');
        var origin = (window.location && window.location.origin) ? window.location.origin : '';
        btn.href = origin + '/language-arts/';
        btn.textContent = '‚Üê Language Arts';
        btn.setAttribute('aria-label', 'Return to Language Arts');
        btn.style.position = 'fixed';
        btn.style.top = '1rem';
        btn.style.left = '1rem';
        btn.style.zIndex = '1000';
        btn.style.background = 'rgba(255,255,255,0.12)';
        btn.style.border = '1px solid rgba(255, 255, 255, 0.25)';
        btn.style.padding = '.6rem 1rem';
        btn.style.borderRadius = '.6rem';
        btn.style.color = '#fff';
        btn.style.textDecoration = 'none';
        btn.style.backdropFilter = 'blur(10px)';
        btn.style.webkitBackdropFilter = 'blur(10px)';
        btn.style.transition = 'background .2s, transform .2s';
        btn.addEventListener('mouseenter', function () {
          btn.style.background = 'rgba(255,255,255,0.24)';
          btn.style.transform = 'translateY(-1px)';
        });
        btn.addEventListener('mouseleave', function () {
          btn.style.background = 'rgba(255,255,255,0.12)';
          btn.style.transform = 'translateY(0)';
        });
        document.body.appendChild(btn);
      } catch (e) { console.error('Failed to add Language Arts button', e); }
    })();
  </script>

  <script>
    // ============== Helpers & Live Feedback Hooks ==============
    function updateWordCount(textareaId, countId) {
      const textarea = document.getElementById(textareaId);
      const countElement = document.getElementById(countId);
      const text = (textarea.value || '').trim();
      const wordCount = text ? text.split(/\s+/).length : 0;
      countElement.textContent = `${wordCount} ${wordCount === 1 ? 'word' : 'words'}`;
    }

    function hookLiveFeedback() {
      const pairs = [
        { id: 'topicSentence', count: 'topicWordCount', check: checkTopicSentence },
        { id: 'supportingDetail1', count: 'detail1WordCount', check: () => checkSupportingDetail('supportingDetail1', 'detail1Feedback') },
        { id: 'supportingDetail2', count: 'detail2WordCount', check: () => checkSupportingDetail('supportingDetail2', 'detail2Feedback') },
        { id: 'supportingDetail3', count: 'detail3WordCount', check: () => checkSupportingDetail('supportingDetail3', 'detail3Feedback') },
        { id: 'conclusion', count: 'conclusionWordCount', check: checkConclusion }
      ];

      const debounce = (fn, ms=150) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };

      pairs.forEach(({ id, count, check }) => {
        const el = document.getElementById(id);
        const update = () => { updateWordCount(id, count); check(); };
        el.addEventListener('input', debounce(update));
        // Initialize on load
        update();
      });
    }

    // ============== Feedback Engines ==============
    function checkTopicSentence() {
      const input = document.getElementById('topicSentence');
      const feedback = document.getElementById('topicFeedback');
      const text = (input.value || '').trim();
      const messages = [];

      if (!text) { feedback.innerHTML = ''; return; }

      if (text[0] === text[0]?.toLowerCase()) {
        messages.push('<p class="error">Your sentence should start with a capital letter.</p>');
      }
      if (!/[.!?]$/.test(text)) {
        messages.push('<p class="error">Your sentence should end with proper punctuation (. ! or ?).</p>');
      }
      if (text.trim().endsWith('?')) {
        messages.push('<p class="error">Topic sentences should be statements, not questions. Make a claim instead of asking.</p>');
      }

      const words = text.split(/\s+/);
      if (text.length < 15) {
        messages.push('<p class="error">Too short. A strong topic sentence needs more development (aim for at least 10-15 words).</p>');
      } else if (words.length < 8) {
        messages.push('<p class="warn">Your sentence is quite brief. Consider adding more detail about your main point.</p>');
      } else if (words.length >= 8 && words.length <= 25) {
        messages.push('<p>‚úîÔ∏è Good sentence length.</p>');
      } else {
        messages.push('<p class="warn">Your sentence is quite long. Consider breaking it into two sentences or simplifying.</p>');
      }

      const weakStarters = /^(i think|i believe|i feel|in my opinion|i guess|i would say|this essay|this paragraph|this paper)/i;
      if (weakStarters.test(text)) {
        messages.push('<p class="error">Avoid weak starters like "I think," "I believe," or "This essay." State your claim directly and confidently.</p>');
      }
      if (/^(yes|no|maybe|sure|not really|kind of|sort of)/i.test(text)) {
        messages.push('<p class="error">This sounds like a simple answer, not a topic sentence. Restate the question as a complete claim in your own words.</p>');
      }

      const pronouns = ["he","she","they","it","we","you","i"];
      const contentWords = text.toLowerCase().replace(/[^a-z\s]/g, '').split(/\s+/);
      const mainWords = contentWords.filter(w => w.length > 3 && !pronouns.includes(w));
      if (mainWords.length === 0) {
        messages.push('<p class="error">Your sentence needs a clear, specific subject. What exactly are you writing about?</p>');
      } else if (mainWords.length < 3) {
        messages.push('<p class="warn">Your topic sentence could be more specific. Add more detail about your subject.</p>');
      } else {
        messages.push('<p>‚úîÔ∏è Your sentence has a clear subject.</p>');
      }

      const vagueWords = /(thing|stuff|good|bad|nice|interesting|a lot|very|really|some|many)/i;
      if (vagueWords.test(text)) {
        messages.push('<p class="warn">Try to be more specific. Avoid vague words like "thing," "stuff," "good," "bad," "nice," "interesting," etc.</p>');
      }

      const purposefulPatterns = /(should|must|because|since|therefore|demonstrates|proves|shows|reveals|argues|suggests|explains|indicates|illustrates|the main reason|one reason|the primary|the key|the most important)/i;
      if (purposefulPatterns.test(text)) {
        messages.push('<p>‚úîÔ∏è Your sentence has clear direction and purpose. Excellent!</p>');
      } else {
        messages.push('<p class="warn">Your sentence needs stronger direction. Include words that show your position or reasoning (e.g., "because," "demonstrates," "should").</p>');
      }

      if (/will (discuss|talk about|explain|write about|tell you)/i.test(text)) {
        messages.push('<p class="error">Don\'t announce what you\'ll do ("I will discuss..."). Instead, make your claim directly.</p>');
      }

      const sentenceCount = (text.match(/[.!?]+/g) || []).length;
      if (sentenceCount > 1) {
        messages.push('<p class="warn">A topic sentence should typically be ONE sentence. Consider combining your ideas or using only the strongest one.</p>');
      }

      if (/n\'t|'re|'ve|'ll|'d|'s/.test(text)) {
        messages.push('<p class="warn">Avoid contractions in formal writing. Write out "don\'t" as "do not," etc.</p>');
      }

      const errorCount = messages.filter(m => m.includes('class="error"')).length;
      const warnCount = messages.filter(m => m.includes('class="warn"')).length;
      if (errorCount === 0 && warnCount === 0) {
        messages.push('<p style="background: rgba(16,185,129,.2); font-weight: bold;">üåü Excellent topic sentence! This is ready to use.</p>');
      } else if (errorCount === 0 && warnCount <= 2) {
        messages.push('<p style="background: rgba(34,197,94,.15);">‚úÖ Good topic sentence! Consider addressing the suggestions above to make it even stronger.</p>');
      } else if (errorCount > 0) {
        messages.push('<p style="background: rgba(239,68,68,.2); font-weight: bold;">‚ö†Ô∏è This needs revision. Please address the errors above before continuing.</p>');
      }

      feedback.innerHTML = messages.join('');
    }

    function checkSupportingDetail(detailId, feedbackId) {
      const detail = document.getElementById(detailId);
      const feedback = document.getElementById(feedbackId);
      const topicSentence = (document.getElementById('topicSentence').value || '').trim();
      const text = (detail.value || '').trim();
      const messages = [];

      if (!text) { feedback.innerHTML = ''; return; }

      const words = text.split(/\s+/);
      if (words.length < 15) {
        messages.push('<p class="error">Too short. Supporting details need substantial development (aim for at least 15-20 words).</p>');
      } else if (words.length < 20) {
        messages.push('<p class="warn">Consider adding more detail. Strong supporting details typically have 20+ words.</p>');
      } else if (words.length <= 75) {
        messages.push('<p>‚úîÔ∏è Good detail length.</p>');
      } else {
        messages.push('<p class="warn">Your detail is quite long. Consider breaking it into multiple sentences or being more concise.</p>');
      }

      const hasEvidence = /(for example|for instance|such as|specifically|according to|shows that|demonstrates|proves|illustrates|evidence|data|study|research|\")/i.test(text);
      if (hasEvidence) { messages.push('<p>‚úîÔ∏è Good! You included specific evidence or examples.</p>'); }
      else { messages.push('<p class="warn">Try to include specific evidence, examples, or data to support your claim.</p>'); }

      const hasExplanation = /(this shows|this demonstrates|this means|this proves|this illustrates|because|therefore|as a result|consequently|thus)/i.test(text);
      if (hasExplanation) { messages.push('<p>‚úîÔ∏è Good! You explained how your evidence supports your point.</p>'); }
      else { messages.push('<p class="warn">Explain how your evidence connects to your topic sentence.</p>'); }

      if (topicSentence) {
        const topicKeyWords = topicSentence.toLowerCase().replace(/[^a-z\s]/g, '').split(/\s+/).filter(w => w.length > 4);
        const detailLower = text.toLowerCase();
        const hasConnection = topicKeyWords.some(word => detailLower.includes(word));
        if (!hasConnection && topicKeyWords.length > 0) {
          messages.push('<p class="warn">This detail doesn\'t clearly connect to your topic sentence. Make sure it supports your main argument.</p>');
        }
      }

      if (!/[.!?]$/.test(text)) {
        messages.push('<p class="error">Your detail should end with proper punctuation.</p>');
      }

      const errorCount = messages.filter(m => m.includes('class="error"')).length;
      if (errorCount === 0 && messages.length <= 3) {
        messages.push('<p style="background: rgba(16,185,129,.2);">‚úÖ Strong supporting detail!</p>');
      }

      feedback.innerHTML = messages.join('');
    }

    function checkConclusion() {
      const conclusion = document.getElementById('conclusion');
      const feedback = document.getElementById('conclusionFeedback');
      const topicSentence = (document.getElementById('topicSentence').value || '').trim();
      const text = (conclusion.value || '').trim();
      const messages = [];

      if (!text) { feedback.innerHTML = ''; return; }

      const words = text.split(/\s+/);
      if (words.length < 20) { messages.push('<p class="error">Too short. Conclusions should restate your thesis and summarize key points (aim for at least 20 words).</p>'); }
      else if (words.length <= 60) { messages.push('<p>‚úîÔ∏è Good conclusion length.</p>'); }
      else { messages.push('<p class="warn">Your conclusion is quite long. Keep it concise while restating your main points.</p>'); }

      if (!/[.!?]$/.test(text)) { messages.push('<p class="error">Your conclusion should end with proper punctuation.</p>'); }

      const introducesNew = /(new|another|also|additionally|furthermore|first time|never mentioned)/i.test(text);
      if (introducesNew) { messages.push('<p class="warn">Avoid introducing completely new ideas in your conclusion. Focus on summarizing what you already discussed.</p>'); }

      if (topicSentence) {
        const topicLower = topicSentence.toLowerCase();
        const conclusionLower = text.toLowerCase();
        const topicWords = topicLower.replace(/[^a-z\s]/g, '').split(/\s+/).filter(w => w.length > 4);
        const sharedWords = topicWords.filter(word => conclusionLower.includes(word));
        if (sharedWords.length === 0 && topicWords.length > 0) {
          messages.push('<p class="error">Your conclusion doesn\'t connect to your topic sentence. Restate your main argument in different words.</p>');
        } else if (sharedWords.length > 0) {
          const similarity = sharedWords.length / topicWords.length;
          if (similarity > 0.7 && topicSentence.length > 30) {
            const topicStart = topicLower.substring(0, 40);
            const conclusionStart = conclusionLower.substring(0, 40);
            if (topicStart === conclusionStart) {
              messages.push('<p class="warn">Your conclusion is too similar to your topic sentence. Restate your thesis using different words.</p>');
            } else {
              messages.push('<p>‚úîÔ∏è Good! Your conclusion restates your main argument.</p>');
            }
          } else {
            messages.push('<p>‚úîÔ∏è Good! Your conclusion connects to your topic sentence.</p>');
          }
        }
      }

      const hasSummary = /(in conclusion|to summarize|in summary|overall|ultimately|therefore|thus|as shown|as demonstrated)/i.test(text);
      if (hasSummary) { messages.push('<p>‚úîÔ∏è Good use of concluding language.</p>'); }

      const weakEndings = /(that is all|the end|that\'s it|i\'m done|this concludes|in this essay i|i have shown)/i;
      if (weakEndings.test(text)) { messages.push('<p class="warn">Avoid weak endings. End with a strong statement or thought-provoking insight.</p>'); }

      const hasImpact = /(important|significant|matters|crucial|essential|should|must|needs|future|impact|consequence)/i.test(text);
      if (hasImpact) { messages.push('<p>‚úîÔ∏è Good! You emphasized the importance or broader implications of your argument.</p>'); }
      else { messages.push('<p class="warn">Consider ending with why your argument matters or what readers should take away.</p>'); }

      const errorCount = messages.filter(m => m.includes('class="error"')).length;
      if (errorCount === 0 && messages.length <= 4) {
        messages.push('<p style="background: rgba(16,185,129,.2);">‚úÖ Strong conclusion!</p>');
      }

      feedback.innerHTML = messages.join('');
    }

    // ============== Compose / Preview / Copy ==============
    function composeResponse() {
      const t = (s) => (s || '').trim();
      const join = (a, b) => a && b ? (a.endsWith(',') || a.endsWith(':') ? `${a} ${b}` : `${a} ${b}`) : (a || b || '');

      const ts = t(document.getElementById('topicSentence').value);
      const tr1 = t(document.getElementById('transition1').value);
      const d1 = t(document.getElementById('supportingDetail1').value);
      const tr2 = t(document.getElementById('transition2').value);
      const d2 = t(document.getElementById('supportingDetail2').value);
      const tr3 = t(document.getElementById('transition3').value);
      const d3 = t(document.getElementById('supportingDetail3').value);
      const trC = t(document.getElementById('transitionConclusion').value);
      const c = t(document.getElementById('conclusion').value);

      const paras = [
        ts,
        join(tr1, d1),
        join(tr2, d2),
        join(tr3, d3),
        join(trC, c)
      ].filter(Boolean);

      return paras.join('\n\n');
    }

    function previewResponse() {
      const text = composeResponse();
      document.getElementById('previewText').textContent = text || 'Nothing to preview yet. Add a topic sentence and details to see your response here.';
      document.getElementById('previewModal').style.display = 'block';
    }

    function closePreview() { document.getElementById('previewModal').style.display = 'none'; }

    function copyResponse() {
      const text = composeResponse();
      if (!text) { alert('Nothing to copy yet. Write something first.'); return; }
      navigator.clipboard.writeText(text).then(() => {
        alert('Response copied to clipboard. Go paste it where you need it.');
      }).catch(() => {
        // Fallback: select & copy via textarea
        const tmp = document.createElement('textarea');
        tmp.value = text; document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
        alert('Response copied to clipboard.');
      });
    }

    function clearAll() {
      ['promptInput','topicSentence','supportingDetail1','supportingDetail2','supportingDetail3','conclusion'].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = '';
      });
      ['transition1','transition2','transition3','transitionConclusion'].forEach(id => {
        const el = document.getElementById(id); if (el) el.selectedIndex = 0;
      });
      ['topicFeedback','detail1Feedback','detail2Feedback','detail3Feedback','conclusionFeedback'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });
      // Reset counts
      updateWordCount('topicSentence','topicWordCount');
      updateWordCount('supportingDetail1','detail1WordCount');
      updateWordCount('supportingDetail2','detail2WordCount');
      updateWordCount('supportingDetail3','detail3WordCount');
      updateWordCount('conclusion','conclusionWordCount');
    }

    document.addEventListener('DOMContentLoaded', hookLiveFeedback);
  </script>
</body>
</html>
